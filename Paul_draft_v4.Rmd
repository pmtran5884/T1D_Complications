---
title: "R Notebook"
output: html_notebook
---

```{r setup}
rm(list=ls(all=TRUE))
    knitr::opts_knit$set(root.dir = normalizePath("/Users/paultran/Box/Students/T1D_complications")) 
```

Clinical Risk of Type 1 Diabetes Complications: A tool to motivate change in patient behavior
Neuropathy, retinopathy, and nephropathy are common complications
patients seeing their true risk and working on modifiable risk factors are the best methods for primary prevention of T1D complications

We used an independent cross sectional study, PAGODA, to develop a clinical risk score for diabetic peripheral neuropathy in T1D patients. 

#Table 1. PAGODA cohort characteristics

```{r}
library(limma)
T1Dcomp_alldata<-read.csv("2_T1DComplications data_cleaned for Paul.csv")
attach(T1Dcomp_alldata)

T1Dcomp_alldata$DPN<-ifelse(Peripheral_Neuropathy3=="Yes",1,0)
T1Dcomp_alldata$CAN<-ifelse(Autonomic_Neuropathy3=="Yes",1,0)
T1Dcomp_alldata$DR<-ifelse(DM_Retinopathy3=="Yes",1,0)
T1Dcomp_alldata$DN<-ifelse(DM_Nephropathy3=="Yes",1,0)

attach(T1Dcomp_alldata)

a<-vennCounts(cbind(DPN,CAN,DR,DN))

table(Peripheral_Neuropathy3);table(Autonomic_Neuropathy3);table(DM_Retinopathy3);table(DM_Nephropathy3);table(Sex);table(Race);table(HTN3);table(Dyslipidemia3);table(Blindness_DM3);table(Photocoagulation3);table(CAD3);table(Prior_Angioplasty_Stent3);table(Prior_CABG3);table(Prior_CVA3);table(Prior_MI3);table(Prior_TIA3);table(CAD3);table(Amputation3);table(Diabetic_Foot_Ulcer3);table(Peripheral_Neuropathy_Type);table(Smoking); summary(Dr_Age);summary(Dx_Age);summary(Dur);summary(Hemoglobin);summary(Albumin);summary(LDL);summary(Total_Cholesterol);summary(Triglycerides);summary(HDL);summary(avg.BUN);summary(avg.Creatinine);summary(avg.Systolic);summary(avg.diastolic);summary(avg.MicroAlb);summary(AvgA1c);summary(ACR); vennDiagram(a)

```

Table 2. Univariate Predictors of T1D Complications
Table with OR 95% CI for each clinical variable and its association with the 4 complications


Univariate associations
```{r}
T1Dcomp_alldata<-read.csv("2_T1DComplications data_cleaned for Paul.csv")
attach(T1Dcomp_alldata)
T1Dcomp_alldata$DPN<-ifelse(Peripheral_Neuropathy3=="Yes",1,0)
T1Dcomp_alldata$CAN<-ifelse(Autonomic_Neuropathy3=="Yes",1,0)
T1Dcomp_alldata$DR<-ifelse(DM_Retinopathy3=="Yes",1,0)
T1Dcomp_alldata$DN<-ifelse(DM_Nephropathy3=="Yes",1,0)

vars <-
  c(
    "Peripheral_Neuropathy3",
    "Autonomic_Neuropathy3",
    "DM_Retinopathy3",
    "DM_Nephropathy3",
    
    "Blindness_DM3",
    "Photocoagulation3",
    "Amputation3",
    "Diabetic_Foot_Ulcer3",
    "Peripheral_Neuropathy_Type",
    
    "Sex",
    "Race",
    "Smoking",
    
    "HTN3",
    "Dyslipidemia3",
    "CAD3",
    "Prior_Angioplasty_Stent3",
    "Prior_CABG3",
    "Prior_CVA3",
    "Prior_MI3",
    "Prior_TIA3",
    
    "Dr_Age",
    "Dx_Age",
    "Dur",
    
    "Hemoglobin",
    "Albumin",
    "LDL",
    "Total_Cholesterol",
    "Triglycerides",
    "HDL",
    "avg.BUN",
    "avg.Creatinine",
    "avg.Systolic",
    "avg.diastolic",
    "avg.MicroAlb",
    "ACR",
    "AvgA1c",
    "SDA1c",
    "HbA1c_3.1",
    "Max_HbA1c",
    
    "Insulin..Aspart..Human",
    "Insulin..Lispro..Human",
    "insulin.glargine..rDNA.origin..injection",
    "acetYes",
    "atorvastatin.calcium",
    "levothYes",
    "lisinopril",
    "ThYes",
    "Simvastatin",
    "ramipril",
    "ibandronate.sodium",
    "Escitalopram",
    "Insulin..Isophane..Human",
    "Valsartan",
    "insulin.detemir",
    "insulin.glulisine.RDNA.origin",
    "Insulin.regular.human.recombinant",
    "insulin..human.recombinant",
    "lovastatin"
  )
suppressWarnings(
cbind(
  t(sapply(paste("DPN ~",vars),
                      function(form) {
  res.logist<-glm(form,data=T1Dcomp_alldata,family="binomial")
  summary(res.logist)$coefficients[2,]
  }
  )),
  t(sapply(paste("CAN ~",vars),
                      function(form) {
  res.logist<-glm(form,data=T1Dcomp_alldata,family="binomial")
  summary(res.logist)$coefficients[2,]
  }
  )),
  t(sapply(paste("DR ~",vars),
                      function(form) {
  res.logist<-glm(form,data=T1Dcomp_alldata,family="binomial")
  summary(res.logist)$coefficients[2,]
  }
  )),
  t(sapply(paste("DN ~",vars),
                      function(form) {
  res.logist<-glm(form,data=T1Dcomp_alldata,family="binomial")
  summary(res.logist)$coefficients[2,]
  }
  ))
)
)


```


Figure 2. Multivariate logistic regression models for 4 complications
A. Variables with coefficients
B. Nomogram
C. AUC of test data
D. Interation of Age and T1D Dur

#Comparing predictive models
```{r}

library(caret)
library(doParallel)
library(dplyr)
library(pROC)
library(glmnet)
source("my_functions.R")
T1Dcomp_alldata<-read.csv("2_T1DComplications data_cleaned for Paul.csv")

set.seed(123)



 # 1) DPN

dpn <- suppressWarnings(compare_3_models(T1Dcomp_alldata,"Peripheral_Neuropathy3",varstoassess = c("Peripheral_Neuropathy3","Autonomic_Neuropathy3","DM_Retinopathy3","DM_Nephropathy3","HTN3","Dyslipidemia3","CAD3","Prior_TIA3","Prior_MI3","Prior_CVA3","Dr_Age","Dur","Hemoglobin","Albumin","avg.Creatinine","avg.Systolic","avg.BUN","avg.MicroAlb","AvgA1c","Sex","HDL","Max_HbA1c")))

 # 2) DAN
can <- suppressWarnings(compare_3_models(T1Dcomp_alldata,"Autonomic_Neuropathy3",varstoassess = c("Autonomic_Neuropathy3","Peripheral_Neuropathy3","DM_Retinopathy3","DM_Nephropathy3","HTN3","Dyslipidemia3","CAD3","Prior_TIA3","Prior_MI3","Prior_CVA3","Dr_Age","Dur","Hemoglobin","Albumin","avg.Creatinine","avg.Systolic","avg.BUN","avg.MicroAlb","AvgA1c","Sex","HDL","Max_HbA1c")))

 # 3) Dret
dr <- suppressWarnings(compare_3_models(T1Dcomp_alldata,"DM_Retinopathy3",varstoassess = c("DM_Retinopathy3","Peripheral_Neuropathy3","Autonomic_Neuropathy3","DM_Nephropathy3","HTN3","Dyslipidemia3","CAD3","Prior_TIA3","Prior_MI3","Prior_CVA3","Dr_Age","Dur","Hemoglobin","Albumin","avg.Creatinine","avg.Systolic","avg.BUN","avg.MicroAlb","AvgA1c","Sex","HDL","Max_HbA1c")))

 # 4) Dnep
dn <- suppressWarnings(compare_3_models(T1Dcomp_alldata,"DM_Nephropathy3",varstoassess = c("DM_Nephropathy3","Peripheral_Neuropathy3","Autonomic_Neuropathy3","DM_Retinopathy3","HTN3","Dyslipidemia3","CAD3","Prior_TIA3","Prior_MI3","Prior_CVA3","Dr_Age","Dur","Hemoglobin","Albumin","avg.Creatinine","avg.Systolic","avg.BUN","avg.MicroAlb","AvgA1c","Sex","HDL","Max_HbA1c")))


#Summary data
paste("____________________________DPN____________________________");dpn$lasso_tst_roc$auc;dpn$rfelogit_tst_roc$auc;dpn$customlogit_tst_roc$auc;dpn$customlogit_tst_roc2$auc;dpn$lasso_coef;dpn$rfelogit_coef;dpn$customlogit_coef;dpn$customlogit_coef2;paste("____________________________CAN____________________________");can$lasso_tst_roc$auc;can$rfelogit_tst_roc$auc;can$customlogit_tst_roc$auc;can$customlogit_tst_roc2$auc;can$lasso_coef;can$rfelogit_coef;can$customlogit_coef;can$customlogit_coef2;paste("____________________________DR____________________________");dr$lasso_tst_roc$auc;dr$rfelogit_tst_roc$auc;dr$customlogit_tst_roc$auc;dr$customlogit_tst_roc2$auc;dr$lasso_coef;dr$rfelogit_coef;dr$customlogit_coef;dr$customlogit_coef2;paste("____________________________DN____________________________");dn$lasso_tst_roc$auc;dn$rfelogit_tst_roc$auc;dn$customlogit_tst_roc$auc;dn$customlogit_tst_roc2$auc;dn$lasso_coef;dn$rfelogit_coef;dn$customlogit_coef;dn$customlogit_coef2


```


#Nomogram and interaction of age and dur
```{r}
#nomogram
library(rms)
T1Dcomp_alldata<-read.csv("2_T1DComplications data_cleaned for Paul.csv")


options(datadist='ddist')
ddist <-datadist(T1Dcomp_alldata)

# 1) dpn
dpn.mod<-lrm(Peripheral_Neuropathy3~Dr_Age+Dur+avg.Systolic+AvgA1c,data=T1Dcomp_alldata,x=TRUE,y=TRUE)
dpn.mod2<-lrm(Peripheral_Neuropathy3~Dr_Age*Dur+avg.Systolic+AvgA1c,data=T1Dcomp_alldata,x=TRUE,y=TRUE)

nom.dpn<-nomogram(dpn.mod2,
                 lp.at = seq(-3,4,by=0.5),
                 fun = function(x)1/(1+exp(-x)),
                     fun.at=c(0.001,0.01,.05,seq(0.1,0.9,by=0.1),0.95,0.99,0.999),
                     funlabel="Risk of Complication",
                 interact = list(Dur=c(5,10,20,30,40)),
                 conf.int=c(0.1,0.7),
                 abbrev=T,
                 minlength=1,lp=F)

# 2) dan
dan.mod<-lrm(Autonomic_Neuropathy3~Dr_Age+Dur+avg.Systolic+AvgA1c,data=T1Dcomp_alldata,x=TRUE,y=TRUE)
dan.mod2<-lrm(Autonomic_Neuropathy3~Dr_Age*Dur+avg.Systolic+AvgA1c,data=T1Dcomp_alldata,x=TRUE,y=TRUE)

nom.dan<-nomogram(dan.mod2,
                 lp.at = seq(-3,4,by=0.5),
                 fun = function(x)1/(1+exp(-x)),
                     fun.at=c(0.001,0.01,.05,seq(0.1,0.9,by=0.1),0.95,0.99,0.999),
                     funlabel="Risk of Complication",
                 interact = list(Dur=c(5,10,20,30,40)),
                 conf.int=c(0.1,0.7),
                 abbrev=T,
                 minlength=1,lp=F)

# 3) dret
dret.mod<-lrm(DM_Retinopathy3~Dr_Age+Dur+avg.Systolic+AvgA1c,data=T1Dcomp_alldata,x=TRUE,y=TRUE)
dret.mod2<-lrm(DM_Retinopathy3~Dr_Age*Dur+avg.Systolic+AvgA1c,data=T1Dcomp_alldata,x=TRUE,y=TRUE)

nom.dret<-nomogram(dret.mod2,
                 lp.at = seq(-3,4,by=0.5),
                 fun = function(x)1/(1+exp(-x)),
                     fun.at=c(0.001,0.01,.05,seq(0.1,0.9,by=0.1),0.95,0.99,0.999),
                     funlabel="Risk of Complication",
                 interact = list(Dur=c(5,10,20,30,40)),
                 conf.int=c(0.1,0.7),
                 abbrev=T,
                 minlength=1,lp=F)

# 4) dnep
dnep.mod<-lrm(DM_Nephropathy3~Dr_Age+Dur+avg.Systolic+AvgA1c,data=T1Dcomp_alldata,x=TRUE,y=TRUE)
dnep.mod2<-lrm(DM_Nephropathy3~Dr_Age*Dur+avg.Systolic+AvgA1c,data=T1Dcomp_alldata,x=TRUE,y=TRUE)
dnep.mod3<-lrm(DM_Nephropathy3~Dr_Age*Dur+avg.Systolic+AvgA1c+avg.Creatinine,data=T1Dcomp_alldata,x=TRUE,y=TRUE)

nom.dnep<-nomogram(dnep.mod2,
                 lp.at = seq(-3,4,by=0.5),
                 fun = function(x)1/(1+exp(-x)),
                     fun.at=c(0.001,0.01,.05,seq(0.1,0.9,by=0.1),0.95,0.99,0.999),
                     funlabel="Risk of Complication",
                 interact = list(Dur=c(5,10,20,30,40)),
                 conf.int=c(0.1,0.7),
                 abbrev=T,
                 minlength=1,lp=F)


#rms::validate(dpn.mod, method="boot", B=500)

#save data
saveRDS(dpn.mod2,file = "/Users/paultran/Box/Students/T1D_complications/Shiny App/T1D_Complications/data/T1Dcomp_DPNmod_logit.rds")
saveRDS(dan.mod2,file = "/Users/paultran/Box/Students/T1D_complications/Shiny App/T1D_Complications/data/T1Dcomp_DANmod_logit.rds")
saveRDS(dret.mod2,file = "/Users/paultran/Box/Students/T1D_complications/Shiny App/T1D_Complications/data/T1Dcomp_DRETmod_logit.rds")
saveRDS(dnep.mod2,file = "/Users/paultran/Box/Students/T1D_complications/Shiny App/T1D_Complications/data/T1Dcomp_DNEPmod_logit.rds")

#summary and plot
summary(dpn.mod2);summary(dan.mod2);summary(dret.mod2);summary(dnep.mod2);plot(nom.dpn);plot(nom.dan);plot(nom.dret);plot(nom.dnep);plot(anova(dpn.mod2), what='proportion chisq');plot(anova(dan.mod2), what='proportion chisq');plot(anova(dret.mod2), what='proportion chisq');plot(anova(dnep.mod2), what='proportion chisq');plot(Predict(dpn.mod2, fun=plogis));plot(Predict(dan.mod2, fun=plogis));plot(Predict(dret.mod2, fun=plogis));plot(Predict(dnep.mod2, fun=plogis));plot(rms::calibrate(dpn.mod, method="boot", B=500), las=1);plot(rms::calibrate(dan.mod, method="boot", B=500), las=1);plot(rms::calibrate(dret.mod, method="boot", B=500), las=1);plot(rms::calibrate(dnep.mod, method="boot", B=500), las=1);plot(rms::calibrate(dpn.mod2, method="boot", B=500), las=1);plot(rms::calibrate(dan.mod2, method="boot", B=500), las=1);plot(rms::calibrate(dret.mod2, method="boot", B=500), las=1);plot(rms::calibrate(dnep.mod2, method="boot", B=500), las=1); lrtest(dpn.mod,dpn.mod2); lrtest(dan.mod,dan.mod2); lrtest(dret.mod,dret.mod2); lrtest(dnep.mod,dnep.mod2)



```


Figure 3. Website developed to motivate change

Key features are risk reporting for 4 complications. How would risk be modified with changes in SBP or HbA1C? How patient compares to others of same Age and T1D dur for modifiable risk factors? Methods to modify risk factors (diet, weight loss association with BP). 

Conclusion: SBP and HbA1C are modifiable risk factors for T1D complications through lifestyle changes and medical management. Motivation to manage SBP and HbA1C may be more difficult for younger individuals and T1D complication risk tool may aid with this.